apiVersion: batch/v1
kind: Job
metadata:
  name: kafka-perf-test
spec:
  parallelism: 2
  completions: 2
  completionMode: Indexed
  template:
    spec:
      restartPolicy: Never
      containers:
      - name: perf-test-consumer
        image: docker.io/bitnami/kafka:3.3.1
        resources:
          requests:
            memory: "1Gi"
            cpu: "500m"
        command:
        - '/bin/sh'
        - '-c'
        - |
          set -e
          kafka-consumer-perf-test.sh \
            --topic test \
            --bootstrap-server kafka-0.kafka-svc:9092 \
            --messages 1000000 \
          | tee /consumer.out
          exit 0
          curl --data-binary @- "$PUSHGATEWAY_URL" <<EOF
            consumer_mbs_per_second $(tail -1 /consumer.out | awk -F ', ' '{print $4}')
            consumer_msgs_per_second $(tail -1 /consumer.out  | awk -F ', ' '{print $6}')
          EOF
      - name: perf-test-producer
        image: docker.io/bitnami/kafka:3.3.1
        resources:
          requests:
            memory: "500Mi"
            cpu: "500m"
        command:
        - '/bin/sh'
        - '-c'
        - |
          set -e
          kafka-producer-perf-test.sh \
            --topic test \
            --num-records 1000000 \
            --throughput -1 \
            --record-size 1000 \
            --producer-props \
                bootstrap.servers=kafka-0.kafka-svc:9092,kafka-1.kafka-svc:9092,kafka-2.kafka-svc:9092 \
                batch.size=1000 \
                acks=1 \
                linger.ms=100000 \
                buffer.memory=268435456 \
                compression.type=none \
                request.timeout.ms=300000 \
          | tee /producer.out
          exit 0
          curl --data-binary @- "$PUSHGATEWAY_URL" <<EOF
            producer_msgs_per_second $(tail -1 /producer.out | cut -f 4 -d ' ')
            producer_avg_ms_latency $(tail -1 /producer.out  | cut -f 8 -d ' ')
            producer_p95_ms_latency $(tail -1 /producer.out  | cut -f 19 -d ' ')
          EOF
